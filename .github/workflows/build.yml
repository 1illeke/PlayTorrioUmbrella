name: Build Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Build only (skip creating/updating GitHub Release)'
        required: false
        default: false
        type: boolean

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Setup Windows Players
        run: |
          if (Test-Path "yt.zip") {
            7z x yt.zip -y
            Remove-Item yt.zip -Force
          } elseif (Test-Path "yt.rar") {
            7z x yt.rar -y
            Remove-Item yt.rar -Force
          }

          # FLATTEN yt/yt -> yt
          if (Test-Path "yt\yt\yt-dlp.exe") {
            Move-Item yt\yt\yt-dlp.exe yt\yt-dlp.exe -Force
            Remove-Item yt\yt -Recurse -Force
          }

      - name: Check yt-dlp (Windows)
        run: |
          if (Test-Path "yt\yt-dlp.exe") {
            Write-Host "✓ yt-dlp found"
          } else {
            Write-Error "❌ yt-dlp not found"
            exit 1
          }

      - name: Setup PlayTorrioPlayer (Windows)
        run: |
          # Remove existing PlayTorrioPlayer if any
          if (Test-Path "PlayTorrioPlayer") {
            Remove-Item PlayTorrioPlayer -Recurse -Force
          }
          New-Item -ItemType Directory -Path PlayTorrioPlayer -Force
          
          # Download Windows version
          $url = "https://github.com/ayman708-UX/PlayTorrioPlayer/releases/download/continuous/PlayTorrioPlayer-win64-portable-continuous-7-g2a16754.zip"
          $zipPath = "PlayTorrioPlayer\player.zip"
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          
          # Extract
          Expand-Archive -Path $zipPath -DestinationPath PlayTorrioPlayer -Force
          Remove-Item $zipPath -Force
          
          # Flatten if nested
          $nested = Get-ChildItem -Path PlayTorrioPlayer -Directory | Select-Object -First 1
          if ($nested -and (Test-Path "$($nested.FullName)\PlayTorrioPlayer.exe")) {
            Get-ChildItem -Path $nested.FullName | Move-Item -Destination PlayTorrioPlayer -Force
            Remove-Item $nested.FullName -Recurse -Force
          }
          
          # Verify - MUST find PlayTorrioPlayer.exe
          if (Test-Path "PlayTorrioPlayer\PlayTorrioPlayer.exe") {
            Write-Host "✓ PlayTorrioPlayer.exe found - App will be able to launch it"
          } else {
            Write-Host "❌ PlayTorrioPlayer.exe NOT FOUND - App will NOT be able to use external player!"
            Write-Host "Directory contents:"
            Get-ChildItem PlayTorrioPlayer -Recurse | Select-Object FullName
            exit 1
          }

      - name: Verify PlayTorrioPlayer can be found by app (Windows)
        run: |
          Write-Host "=== PlayTorrioPlayer Verification ==="
          Write-Host "Expected path: PlayTorrioPlayer\PlayTorrioPlayer.exe"
          
          $exePath = "PlayTorrioPlayer\PlayTorrioPlayer.exe"
          if (Test-Path $exePath) {
            $fileInfo = Get-Item $exePath
            Write-Host "✓ FOUND: $exePath"
            Write-Host "  Size: $($fileInfo.Length / 1MB) MB"
            Write-Host "  Modified: $($fileInfo.LastWriteTime)"
            Write-Host ""
            Write-Host "✓ App will successfully find and launch PlayTorrioPlayer"
          } else {
            Write-Host "❌ NOT FOUND: $exePath"
            Write-Host ""
            Write-Host "Contents of PlayTorrioPlayer folder:"
            Get-ChildItem PlayTorrioPlayer -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
            Write-Host ""
            Write-Host "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          }

      - name: Setup FFmpeg (Windows)
        run: node build/setup-ffmpeg.cjs win

      - run: npm run build -- --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: dist/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - name: Extract yt-dlp (Linux)
        run: |
          if [ -f linyt.zip ]; then
            unzip -q linyt.zip
            rm -f linyt.zip
          elif [ -f linyt.rar ]; then
            sudo apt-get update -y
            sudo apt-get install -y unar
            unar -o . linyt.rar
            rm -f linyt.rar
          fi

          # FLATTEN linyt/linyt -> linyt
          if [ -f linyt/linyt/yt-dlp_linux ]; then
            mv linyt/linyt/yt-dlp_linux linyt/yt-dlp_linux
            chmod +x linyt/yt-dlp_linux
            rm -rf linyt/linyt
          fi

      - name: Check yt-dlp (Linux)
        run: |
          if [ -f linyt/yt-dlp_linux ] || [ -f linyt/yt-dlp ]; then
            chmod +x linyt/yt-dlp* || true
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (Linux)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download Linux AppImage
          curl -L -o PlayTorrioPlayer/PlayTorrioPlayer.AppImage \
            "https://github.com/ayman708-UX/PlayTorrioPlayer/releases/download/continuous/PlayTorrioPlayer-linux-portable-continuous-7-g2a16754.AppImage"
          
          chmod +x PlayTorrioPlayer/PlayTorrioPlayer.AppImage
          
          # Verify - MUST find AppImage
          if [ -f PlayTorrioPlayer/PlayTorrioPlayer.AppImage ]; then
            echo "✓ PlayTorrioPlayer.AppImage found - App will be able to launch it"
            ls -la PlayTorrioPlayer/
          else
            echo "❌ PlayTorrioPlayer.AppImage NOT FOUND!"
            exit 1
          fi

      - name: Verify PlayTorrioPlayer can be found by app (Linux)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Expected: Any .AppImage file containing 'PlayTorrioPlayer' in PlayTorrioPlayer/"
          echo ""
          
          # Check for AppImage (same logic as server.mjs)
          APPIMAGE=$(find PlayTorrioPlayer -maxdepth 1 -name "*.AppImage" -name "*PlayTorrioPlayer*" | head -1)
          
          if [ -n "$APPIMAGE" ] && [ -f "$APPIMAGE" ]; then
            echo "✓ FOUND: $APPIMAGE"
            echo "  Size: $(du -h "$APPIMAGE" | cut -f1)"
            echo "  Executable: $(test -x "$APPIMAGE" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
          else
            echo "❌ NO AppImage found!"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            ls -la PlayTorrioPlayer/
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (Linux)
        run: node build/setup-ffmpeg.cjs linux

      - run: npm run build -- --linux --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist/

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          # FLATTEN macyt/macyt -> macyt
          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS x64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (macOS)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download macOS version
          curl -L -o PlayTorrioPlayer/player.zip \
            "https://github.com/ayman708-UX/PlayTorrioPlayer/releases/download/continuous/PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754.zip"
          
          # Extract
          cd PlayTorrioPlayer
          unzip -q player.zip
          rm -f player.zip
          
          # Flatten if nested (but keep .app structure)
          if [ -d "PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754" ]; then
            mv PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754/* . 2>/dev/null || true
            rm -rf PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754
          fi
          
          # Set executable permissions
          if [ -f "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            chmod +x "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
            echo "✓ PlayTorrioPlayer.app found"
          else
            echo "⚠ PlayTorrioPlayer.app not found, listing contents:"
            find . -type f | head -20
          fi
          cd ..

      - name: Verify PlayTorrioPlayer can be found by app (macOS x64)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Expected: PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          echo ""
          
          PLAYER_PATH="PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          
          if [ -f "$PLAYER_PATH" ]; then
            echo "✓ FOUND: $PLAYER_PATH"
            echo "  Size: $(du -h "$PLAYER_PATH" | cut -f1)"
            echo "  Executable: $(test -x "$PLAYER_PATH" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
          else
            echo "❌ NOT FOUND: $PLAYER_PATH"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            find PlayTorrioPlayer -type f | head -20
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (macOS)
        run: node build/setup-ffmpeg.cjs mac

      - run: npm run build -- --mac --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-x64
          path: dist/

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install --verbose || npm install --verbose || npm install --verbose

      - name: Extract yt-dlp (macOS)
        run: |
          if [ -f macyt.zip ]; then
            unzip -q macyt.zip
            rm -f macyt.zip
          elif [ -f macyt.rar ]; then
            brew install unar || true
            unar -o . macyt.rar
            rm -f macyt.rar
          fi

          if [ -f macyt/macyt/yt-dlp_macos ]; then
            mv macyt/macyt/yt-dlp_macos macyt/yt-dlp_macos
            chmod +x macyt/yt-dlp_macos
            rm -rf macyt/macyt
          fi

      - name: Check yt-dlp (macOS arm64)
        run: |
          if [ -f macyt/yt-dlp_macos ]; then
            echo "✓ yt-dlp found"
          else
            echo "❌ yt-dlp not found" && exit 1
          fi

      - name: Setup PlayTorrioPlayer (macOS)
        run: |
          # Remove existing PlayTorrioPlayer if any
          rm -rf PlayTorrioPlayer
          mkdir -p PlayTorrioPlayer
          
          # Download macOS version
          curl -L -o PlayTorrioPlayer/player.zip \
            "https://github.com/ayman708-UX/PlayTorrioPlayer/releases/download/continuous/PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754.zip"
          
          # Extract
          cd PlayTorrioPlayer
          unzip -q player.zip
          rm -f player.zip
          
          # Flatten if nested (but keep .app structure)
          if [ -d "PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754" ]; then
            mv PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754/* . 2>/dev/null || true
            rm -rf PlayTorrioPlayer-macOS-portable-continuous-7-g2a16754
          fi
          
          # Set executable permissions
          if [ -f "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer" ]; then
            chmod +x "PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
            echo "✓ PlayTorrioPlayer.app found"
          else
            echo "⚠ PlayTorrioPlayer.app not found, listing contents:"
            find . -type f | head -20
          fi
          cd ..

      - name: Verify PlayTorrioPlayer can be found by app (macOS arm64)
        run: |
          echo "=== PlayTorrioPlayer Verification ==="
          echo "Expected: PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          echo ""
          
          PLAYER_PATH="PlayTorrioPlayer/PlayTorrioPlayer.app/Contents/MacOS/PlayTorrioPlayer"
          
          if [ -f "$PLAYER_PATH" ]; then
            echo "✓ FOUND: $PLAYER_PATH"
            echo "  Size: $(du -h "$PLAYER_PATH" | cut -f1)"
            echo "  Executable: $(test -x "$PLAYER_PATH" && echo 'Yes' || echo 'No')"
            echo ""
            echo "✓ App will successfully find and launch PlayTorrioPlayer"
          else
            echo "❌ NOT FOUND: $PLAYER_PATH"
            echo ""
            echo "Contents of PlayTorrioPlayer folder:"
            find PlayTorrioPlayer -type f | head -20
            echo ""
            echo "❌ BUILD WILL FAIL - App cannot find player executable!"
            exit 1
          fi

      - name: Setup FFmpeg (macOS)
        run: node build/setup-ffmpeg.cjs mac

      - run: npm run build -- --mac --arm64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - uses: actions/upload-artifact@v4
        with:
          name: dist-macos-arm64
          path: dist/
  finalize-release:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_release != 'true' }}
    needs:
      - build-windows
      - build-linux
      - build-macos-x64
      - build-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: ver
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT

      - name: Ensure tag uses v prefix
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          echo "Using tag: $TAG"

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true

      - name: Update GitHub Release (title + notes + binaries, keep draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          generate_release_notes: true
          draft: true
          prerelease: false
          files: |
            *.exe
            *.AppImage
            *.deb
            *.dmg
            *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
